<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_preparation.xml" version="5.0" xml:id="cha-update-preparation">
 <title>Preparazione dell&apos;upgrade</title>
 <info>
  <abstract>
   <para>
    Prima di iniziare la procedura di upgrade, assicurarsi che il sistema sia preparato correttamente. Tra le altre cose, la preparazione prevede il backup dei dati e il controllo delle note di rilascio. Il seguente capitolo offre indicazioni su questa procedura.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <remark>jufa 2021-02-09: suggestion to give this chapter a facelift:
 Chapter 3: Preparing the upgrade - Intro - Procedure w check system version,
 release notes, back-up, listing packages, create proposal</remark>
 

 <sect1 xml:id="sec-update-preparation-update">
  <title>Assicurarsi che il sistema sia aggiornato</title>

  <para os="sles;sled">
   <remark>jufa 2021-02-09: add what to do if the system is older? check what
    is meant with patch level. check if update path is supported,
    link to sec-upgrade-path-supported</remark>
   L&apos;upgrade del sistema è supportato solo dal livello di patch più recente. Assicurarsi che siano installati gli ultimi aggiornamenti del sistema <phrase os="sles;sled">o</phrase> eseguendo <command>zypper
   patch</command><phrase os="sles;sled"> o avviando il modulo YaST <guimenu>Online-Update</guimenu></phrase>.
  </para>

  


    <note os="sles;sled" xml:id="new-4096-bit-rpm-key">
      <title>Nuova chiave di firma a 4096 bit per SUSE Linux Enterprise 15</title>
      <para>
        A metà del 2023, la famiglia di prodotti SUSE Linux Enterprise 15 è passata da una chiave di firma RSA a 2048 bit a una nuova chiave RSA a 4096 bit. Questa modifica riguarda i pacchetti RPM, i repository dei pacchetti e le firme ISO. I precedenti repository non più aggiornati e gli RPM rilasciati fino alla data di passaggio alla nuova chiave rimarranno firmati con la vecchia chiave a 2048 bit.
      </para>
      <para>
        Se si aggiorna il sistema, la nuova chiave viene automaticamente importata nel gestore di chiavi RPM dal pacchetto <package>suse-build-key</package> su SLE 15 SP 4 e SP5 nonché nelle versioni LTSS di SLE 15 SP1, SP2 e SP3.
      </para>
      <para>
        Se la chiave non è stata ancora importata, è possibile importarla manualmente con:
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>rpm --import /usr/lib/rpm/gnupg/keys/gpg-pubkey-3fa1d6ce-63c9481c.asc</command></screen>
      <para>
        Se si sta utilizzando una versione precedente di SLE o se la nuova chiave non è stata ancora importata, viene richiesto di considerarla attendibile durante l&apos;upgrade. Assicurarsi che l&apos;impronta digitale corrisponda:
      </para>
<screen>pub   rsa4096/0xF74F09BC3FA1D6CE 2023-01-19 [SC] [expires: 2027-01-18]
Key fingerprint = 7F00 9157 B127 B994 D5CF  BE76 F74F 09BC 3FA1 D6CE
uid           SUSE Package Signing Key &lt;build@suse.de&gt;</screen>
      <para>
        Inoltre, è stata importata una chiave RSA a 4096 bit di riserva a fini di ripristino di emergenza:
      </para>
<screen>pub   rsa4096/0xA1BFC02BD588DC46 2023-01-19 [SC] [expires: 2033-01-16]
Key fingerprint = B56E 5601 41D8 F654 2DFF  3BF9 A1BF C02B D588 DC46
uid           SUSE Package Signing Key (reserve key) &lt;build@suse.de&gt;</screen>
      <para>
        Questa chiave può essere importata manualmente utilizzando:
      </para>
      <screen><prompt>&gt; </prompt><command>sudo</command> <command>rpm --import /usr/lib/rpm/gnupg/keys/gpg-pubkey-d588dc46-63c939db.asc</command></screen>
      <para>
        Entrambe le chiavi sono reperibili anche nel supporto di installazione e nel sito web SUSE all&apos;indirizzo <link xlink:href="https://www.suse.com/support/security/keys/"/>.
      </para>
    </note>

 </sect1>
 <sect1 xml:id="sec-update-preparation-relnotes">
  <title>Lettura delle note di rilascio</title>

  <para>
   Nelle <link xlink:href="https://www.suse.com/releasenotes/">release notes</link> è presente un elenco di tutte le modifiche, delle nuove funzioni e dei problemi noti. Le note di rilascio sono disponibili anche nella directory <filename>docu</filename> del supporto di installazione.
  </para>

  <para>
   In genere le note di rilascio contengono solo le differenze tra due release consecutive. <phrase os="sles;sled">Se si ignora uno o più Service Pack, controllare anche nelle note di rilascio le informazioni relative al Service Pack ignorato.</phrase>
  </para>

  <para>
   Consultare le note di rilascio per verificare se si applica quanto segue:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     L&apos;hardware necessita di considerazioni speciali.
    </para>
   </listitem>
   <listitem>
    <para>
     Sono state apportate modifiche significative a uno qualsiasi dei pacchetti software attualmente in uso
    </para>
   </listitem>
   <listitem>
    <para>
     L&apos;installazione richiede precauzioni speciali.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-update-preparation-backup">
  <title>Esecuzione di un backup</title>

  <para>
   Prima dell&apos;upgrade, eseguire un backup dei dati copiando i file di configurazione esistenti in un supporto distinto (ad esempio un dispositivo a nastro, un disco rigido rimovibile e così via). Questo vale soprattutto per i file memorizzati in <filename>/etc</filename> e per alcuni file e directory in <filename>/var</filename> e <filename>/opt</filename>. Può anche essere opportuno salvare i dati dell&apos;utente contenuti in <filename>/home</filename> (ovvero le directory <envar>HOME</envar>) su un supporto di backup.
  </para>

  <para>
   Eseguire il backup di tutti i dati come <systemitem class="username">root</systemitem>. Solo gli utenti <systemitem class="username">root</systemitem> dispongono delle autorizzazioni di lettura per tutti i file locali.
  </para>

  <para os="sles;sled">
   <remark>jufa 2021-02-09: check if backup function still exists and how it
    works. rework para accordingly: alternative for data back up</remark>
   Se in YaST si è selezionata la modalità di installazione <guimenu>Aggiornamento di un sistema esistente</guimenu>, è possibile scegliere di eseguire un backup (del sistema) in un momento successivo. È possibile includere tutti i file modificati e i file della directory <filename>/etc/sysconfig</filename>. Si tratta tuttavia di un backup parziale in quanto mancano tutte le altre directory importanti indicate sopra. Trovare il backup nella directory <filename>/var/adm/backup</filename>.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-disk">
  <title>Verifica dello spazio su disco disponibile</title>

  <para>
   I programmi tendono a crescere da una versione all&apos;altra. Quindi, prima di effettuare un aggiornamento, controllare lo spazio disponibile nella partizione. Se si teme di esaurire lo spazio su disco, eseguire il backup dei dati prima di incrementare lo spazio disponibile, ad esempio ridimensionando le partizioni. Non esiste una regola generale in merito allo spazio che deve essere disponibile in ogni partizione. I requisiti di spazio dipendono dal particolare profilo di partizionamento e dal software selezionato.
  </para>

  <note os="sles;sled">
   <title>verifica automatica della disponibilità di spazio sufficiente in YaST</title>
   <para>
    Durante la procedura di aggiornamento YaST controlla la quantità di spazio su disco disponibile su disco e visualizza un avviso se vi è la possibilità che l&apos;installazione superi tale valore. In questo caso, l&apos;aggiornamento potrebbe <emphasis>rendere inutilizzabile il sistema</emphasis>. È possibile ignorare l&apos;avviso e continuare con l&apos;aggiornamento solo se si sa esattamente cosa si sta facendo (sulla base dei test eseguiti in precedenza).
   </para>
  </note>

  <sect2 os="sles;sled" xml:id="sec-update-preparation-disk-space">
   <title>Verifica dello spazio su disco nei file system diversi da Btrfs</title>
   <para>
    Per visualizzare lo spazio disponibile su disco, utilizzare il comando <command>df</command>. Ad esempio, nell&apos;<xref linkend="ex-update-df"/>, la partizione radice è <filename>/dev/sda3</filename> (montata come <filename>/</filename>).
   </para>
   <example xml:id="ex-update-df">
    <title>elenco con <command>df -h</command></title>
    
    <screen os="sles">Filesystem     Size  Used Avail Use% Mounted on
     /dev/sda3       74G   22G   53G  29% /
     tmpfs          506M     0  506M   0% /dev/shm
     /dev/sda5      116G  5.8G  111G   5% /home
     /dev/sda1       44G    4G   40G   9% /data</screen>
   </example>
  </sect2>

  <sect2 xml:id="sec-update-preparation-disk-btrfs-on-root">
   <title>Verifica dello spazio su disco nei file system Btrfs</title>
   
   <para>
    Su un file system Btrfs, l&apos;output di <command>df</command> può essere fuorviante, poiché oltre allo spazio allocato ai dati non elaborati, il file system Btrfs assegna e utilizza spazio anche per i metadati.
   </para>
   <para>
    Di conseguenza, è possibile che venga visualizzato un messaggio di spazio esaurito nel file system Btrfs, anche se sembra che lo spazio ancora disponibile sia più che sufficiente. In questo caso, tutto lo spazio allocato ai metadati è stato utilizzato. <phrase os="sles">Per dettagli su come verificare lo spazio in uso e disponibile su un file system Btrfs, vedere il <xref linkend="sec-filesystems-major-btrfs-suse-space"/>&#x002E;</phrase> Per maggiori informazioni, consultare <phrase os="sles;sled"><command>man 8
     btrfs-filesystem</command> e </phrase><link xlink:href="https://btrfs.wiki.kernel.org/index.php/FAQ"/>.
   </para>
   
   <para os="sles;sled">
    Se si utilizza Btrfs per i file system root sul computer, assicurarsi che lo spazio libero sia sufficiente. Verificare lo spazio disponibile su tutte le partizioni montate. Nel caso peggiore, per un upgrade è necessaria la stessa quantità di spazio su disco del file system radice attuale (senza <filename>/.snapshot</filename>) per una nuova istantanea.
   </para>
   
   <para>
    Sono stati comprovati i seguenti consigli:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Per tutti i file system, incluso Btrfs, è necessario spazio su disco sufficiente per effettuare il download e installare RPM di grandi dimensioni. Lo spazio occupato dagli RPM meno recenti viene liberato soltanto in seguito all&apos;installazione di nuovi RPM.
     </para>
    </listitem>
    <listitem>
     <para>
      Per il file system Btrfs con snapshot, è necessaria almeno la stessa quantità di spazio su disco richiesta per l&apos;installazione corrente. È consigliabile avere a disposizione il doppio dello spazio occupato dall&apos;installazione corrente.
     </para>
     <para>
      Se lo spazio libero non è sufficiente, provare a eliminare le istantanee precedenti con il comando <command>snapper</command>:
     </para>
     <screen><prompt role="root"># </prompt><command>snapper</command> list
      <prompt role="root"># </prompt><command>snapper</command> delete NUMBER</screen>
     <para>
      Questa soluzione tuttavia potrebbe non funzionare in tutti i casi. Prima della migrazione, la maggior parte degli snapshot occupa una quantità ridotta di spazio.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-update-preparation-packagelist">
  <title>Elenco dei pacchetti installati e dei repository</title>

  <para>
   <remark>jufa 2021-02-08: explain importance and purposeof this list.
    Clarify if requirement or suggestion?
    Used for reverting changes or to set-up new system?</remark>
   È possibile salvare un elenco dei pacchetti installati; ad esempio quando si esegue una nuova installazione di una release principale di SLE o si ripristina la versione precedente.
  </para>

  <note>
   <para>
    <remark>jufa: check if manual editing is still relevant 2021-02-09</remark>
    È opportuno sapere che nelle release più recenti di SUSE Linux Enterprise, non tutti i pacchetti installati o gli archivi utilizzati sono disponibili. Alcuni potrebbero essere stati rinominati e altri sostituiti. È inoltre possibile che alcuni pacchetti siano ancora disponibili per poter essere utilizzati quando per default è in uso un altro pacchetto. Pertanto, potrebbe essere necessario apportare manualmente alcune modifiche ai file. A tal fine, è possibile utilizzare un editor di testi.
   </para>
  </note>

  <procedure>
   <step>
    <para>
     Creare un file denominato <filename>repositories.bak.repo</filename> contenente un elenco di tutti gli archivi utilizzati:
    </para>
<screen><prompt role="root"># </prompt><command>zypper</command> lr -e repositories.bak</screen>
   </step>
   <step>
    <para>
     Creare anche un file denominato <filename>installed-software.bak</filename> contenente un elenco di tutti i pacchetti installati:
    </para>
<screen><prompt role="root"># </prompt><command>rpm</command> -qa --queryformat '%{NAME}\n' &gt;
     installed-software.bak</screen>
   </step>
   <step>
    <para>
     Eseguire il backup di entrambi i file. È possibile ripristinare gli archivi e i pacchetti installati con i seguenti comandi:
    </para>
<screen os="sles;sled"><prompt role="root"># </prompt><command>zypper</command> ar repositories.bak.repo
<prompt role="root"># </prompt><command>zypper</command> install $(cat installed-software.bak)
</screen>

    <note os="sles;sled" xml:id="note-update-prep-backup-package-amount">
     <title>il numero di pacchetti aumenta con l&apos;aggiornamento a una nuova release principale</title>
     <para>
      Un sistema di cui si è eseguito l&apos;upgrade a una nuova versione principale (SLE <replaceable>X+1</replaceable>) può contenere più pacchetti rispetto al sistema iniziale (SLE <replaceable>X</replaceable>). Contiene anche più pacchetti rispetto a una nuova installazione di SLE <replaceable>X+1</replaceable> con la stessa selezione di modelli. I motivi di questo comportamento sono i seguenti:
     </para>
     <itemizedlist>
      <listitem>
       <para>
        I pacchetti sono stati suddivisi per consentirne una selezione più granulare. Ad esempio, 37 pacchetti <package>texlive</package> su SLE 11 sono stati suddivisi in più di 3000 pacchetti su SLE 15.
       </para>
      </listitem>
      <listitem>
       <para>
        Quando un pacchetto viene suddiviso in più pacchetti, tutti i nuovi pacchetti vengono installati nell&apos;upgrade, in modo da mantenere le stesse funzionalità della versione precedente. Per una nuova installazione di SLE <replaceable>X+1</replaceable> è tuttavia possibile che il nuovo default sia di non installare tutti i pacchetti.
       </para>
      </listitem>
      <listitem>
       <para>
        È possibile che i pacchetti esistenti in SLE <replaceable>X</replaceable> siano stati mantenuti ai fini della compatibilità.
       </para>
      </listitem>
      <listitem>
       <para>
        Le dipendenze dei pacchetti e l&apos;ambito dei modelli potrebbero essere stati modificati.
       </para>
      </listitem>
     </itemizedlist>
    </note>
    
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-update-preparation-ltss">
  <title>Disabilitazione dell&apos;estensione LTSS</title>
  <para>
   Se si esegue l&apos;upgrade di un sistema <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> con service pack (LTSS) a una versione ancora coperta da supporto generale, l&apos;upgrade avrà esito negativo e sarà visualizzato l&apos;errore <literal>No migration available</literal> (Nessuna migrazione disponibile). Ciò si verifica perché <command>zypper migration</command> tenta di migrare <emphasis>tutti</emphasis> i repository, ma ancora non ve n&apos;è alcuno LTSS per la nuova versione.
  </para>
  <para>
   Per correggere questo problema, disabilitare l&apos;estensione LTSS prima dell&apos;upgrade.
  </para>
  <procedure>
   <step>
    <para>
     Verificare che l&apos;estensione LTSS sia abilitata:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> SUSEConnect --list-extensions | grep LTSS
SUSE Linux Enterprise Server LTSS 12 SP4 x86_64 (Installed)
Deactivate with: SUSEConnect -d -p SLES-LTSS/12.4/x86_64</screen>
   </step>
   <step>
    <para>
     Disabilitare l&apos;estensione LTSS con il comando dell&apos;output <command>SUSEConnect</command> riportato sopra:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> SUSEConnect -d -p SLES-LTSS/12.4/x86_64
Deregistered SUSE Linux Enterprise Server LTSS 12 SP4 x86_64
To server: https://scc.suse.com/</screen>
   </step>
   <step>
    <para>
     Verificare che il repository LTSS non sia più presente con <command>zypper lr</command>.
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 os="sles" xml:id="sec-update-preparation-postgresql">
  <title>Migrazione del database PostgreSQL</title>

  <para>
   
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> <phrase role="productnumber"><phrase os="sles;sled">15 SP6</phrase></phrase> include le versioni 14 e 15 del database PostgreSQL. La versione 15 è quella predefinita, ma viene comunque fornita la versione 14 tramite il modulo <literal>Legacy</literal> per gli upgrade dalle versioni precedenti di <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>.
  </para>

  <para>
   A causa del lavoro richiesto per la migrazione del database, non è disponibile alcun processo di upgrade automatico. Il passaggio da una versione all&apos;altra deve essere pertanto effettuato manualmente.
  </para>

  <para>
   Il processo di migrazione viene eseguito mediante il comando <command>pg_upgrade</command>, un metodo alternativo al classico dump e ricaricamento. Rispetto al metodo di <quote>dump e ricaricamento</quote>, <command>pg_upgrade</command> rende più rapida la migrazione.
  </para>

  <para>
   I file di programma per ciascuna versione di PostgreSQL vengono memorizzati in directory diverse in base alla versione. Ad esempio, in <filename>/usr/lib/postgresql96/</filename> per la versione 9.6, in <filename>/usr/lib/postgresql10/</filename> per la versione 10 e in <filename>/usr/lib/postgres13/</filename> per la versione 13. Tenere presente che la policy del controllo versioni di PostgreSQL è stata modificata dalla versione principale 9.6 alla versione principale 10. Per informazioni, vedere <link xlink:href="https://www.postgresql.org/support/versioning/"/>.
  </para>

  <important>
   <title>upgrade da SLE 11</title>
   <para>
    Quando si esegue l&apos;upgrade da SLE 11, <systemitem>postgresql94</systemitem> verrà disinstallato e non sarà possibile utilizzarlo per la migrazione del database a una versione successiva di PostgreSQL. Pertanto, in questo caso assicurarsi di eseguire la migrazione del database PostgreSQL <emphasis>prima</emphasis> di eseguire l&apos;upgrade del sistema.
   </para>
  </important>

  <para>
   Nella procedura riportata di seguito è descritta la migrazione del database dalla versione 12 alla 13. Quando si utilizza una versione diversa come avvio o destinazione, sostituire i numeri di versione di conseguenza.
  </para>

  <para>
   Per eseguire la migrazione del database, procedere come segue:
  </para>

  <procedure>
   <step>
    <para>
     Verificare che siano soddisfatte le seguenti condizioni preliminari:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Eseguire l&apos;upgrade di tutti i pacchetti della versione precedente di PostgreSQL all&apos;ultima release mediante un aggiornamento di manutenzione.
      </para>
     </listitem>
     <listitem>
      <para>
       Creare una copia di backup del database esistente.
      </para>
     </listitem>
     <listitem>
      <para>
       Installare i pacchetti per la nuova versione principale di PostgreSQL. Per SLE 15 SP6 ciò significa che occorre installare <package>postgresql13-server</package> e tutti i pacchetti da cui dipende.
      </para>
     </listitem>
     <listitem>
      <para>
       Installare il pacchetto <package>postgresql13-contrib</package> contenente il comando <command>pg_upgrade</command>.
      </para>
     </listitem>
     <listitem>
      <para>
       Verificare che sia disponibile spazio sufficiente nell&apos;area dati di PostgreSQL, che per default è <filename>/var/lib/pgsql/data</filename>. Se lo spazio è limitato, provare a ridurre le dimensioni con il comando SQL seguente su ciascun database. Questa operazione può richiedere molto tempo:
      </para>
<screen>VACUUM FULL</screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Interrompere il server PostgreSQL in uno dei seguenti modi:
    </para>
<screen><prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
    <para>
     oppure
    </para>
<screen><prompt role="root"># </prompt>systemctl stop postgresql.service</screen>
    <para>
     (a seconda della versione SLE utilizzata come versione iniziale per l&apos;upgrade).
    </para>
   </step>
   <step>
    <para>
     Ridenominare la directory dei dati precedente:
    </para>
<screen><prompt role="root"># </prompt><command>mv</command> /var/lib/pgsql/data /var/lib/pgsql/data.old</screen>
   </step>
   <step>
    <para>
     Inizializzare la nuova istanza di database manualmente con il comando <command>initdb</command> o in modo automatico avviando e arrestando il server PostgreSQL:
    </para>
<screen><prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> start
<prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
    <para>
     oppure
    </para>
<screen><prompt role="root"># </prompt>systemctl start postgresql.service
<prompt role="root"># </prompt>systemctl stop postgresql.service</screen>
    <para>
     (a seconda della versione SLE utilizzata come versione iniziale per l&apos;upgrade).
    </para>
   </step>
   <step>
    <para>
     Se i file di configurazione nella versione precedente sono stati modificati, si consiglia di riportare tali modifiche nei nuovi file di configurazione. Questo potrebbe avere un impatto sui file <filename>postgresql.auto.conf</filename>, <filename>postgresql.conf</filename>,<filename>pg_hba.conf</filename> e <filename>pg_ident.conf</filename>. Le versioni precedenti di questi file si trovano in <filename>/var/lib/pgsql/data.old/</filename> e le nuove versioni sono disponibili in <filename>/var/lib/pgsql/data</filename>.
    </para>
    <para>
     Non è consigliabile copiare i file di configurazione precedenti, in quanto tale operazione può comportare la sovrascrittura delle nuove opzioni, delle nuove impostazioni predefinite e dei commenti modificati.
    </para>
   </step>
   <step>
    <para>
     Avviare il processo di migrazione come utente <systemitem class="username">postgres</systemitem>:
    </para>
<screen><prompt role="root"># </prompt>su - postgres
postgres &gt; <command>pg_upgrade</command> \
 --old-datadir "/var/lib/pgsql/data.old" \
 --new-datadir "/var/lib/pgsql/data" \
 --old-bindir "/usr/lib/postgresql12/bin/" \
 --new-bindir "/usr/lib/postgresql13/bin/"</screen>
   </step>
   <step>
    <para>
     Avviare la nuova istanza del database in uno dei seguenti modi:
    </para>
<screen><prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> start</screen>
    <para>
     oppure
    </para>
<screen><prompt role="root"># </prompt>systemctl start postgresql.service</screen>
    <para>
     (a seconda della versione SLE utilizzata come versione iniziale per l&apos;upgrade).
    </para>
   </step>
   <step>
    <para>
     Controllare che la migrazione sia stata eseguita correttamente. L&apos;ambito della prova dipende dal caso di utilizzo e non esistono strumenti generici per automatizzare questo passaggio.
    </para>
   </step>
   <step>
    <para>
     Rimuovere tutti i pacchetti di PostgreSQL e la directory dei dati precedenti:
    </para>
<screen><prompt role="root"># </prompt><command>zypper</command> search -s postgresql12| xargs zypper rm -u
<prompt role="root"># </prompt><command>rm</command> -rf /var/lib/pgsql/data.old</screen>
   </step>
  </procedure>

  <para>
   Per ulteriori informazioni sull&apos;upgrade dei database o sull&apos;utilizzo di metodi alternativi, come la replica logica, fare riferimento alla documentazione ufficiale di PostgreSQL all&apos;indirizzo <link xlink:href="https://www.postgresql.org/docs/13/upgrading.html"/>.
  </para>
 </sect1>

 <sect1 os="sles" xml:id="sec-update-preparation-mariadb">
  <title>Migrazione del database MySQL o MariaDB</title>
  <remark>toms 2015-09-03: already reviewed by Ondrej and Kristýna.</remark>
  <para>
   A partire da SUSE Linux Enterprise 12, SUSE è passato da MySQL a MariaDB. Prima di iniziare un upgrade, si consiglia vivamente di eseguire il backup del database.
  </para>
  <para>
   Per eseguire la migrazione del database, procedere come segue:
  </para>
  <procedure>
   <step>
    <para>
     Creare un file di dump:
    </para>
    <remark>cwickert 2022-07-07: '--add-drop-database' is required for <link xlink:href="https://bugzilla.suse.com/show_bug.cgi?id=1166786">BSC#1166786</link>&#x002E;</remark>
    <screen><prompt role="root"># </prompt><command>mysqldump</command> -u root -p --all-databases --add-drop-database &gt; mysql_backup.sql</screen>
    <para>
     Per default, <command>mysqldump</command> non effettua il dump del database <literal>INFORMATION_SCHEMA</literal> o <literal>performance_schema</literal>. Per ulteriori informazioni, fare riferimento a <link xlink:href="https://mariadb.com/kb/en/mariadb-dumpmysqldump/"/>.
    </para>
   </step>
   <step>
    <para>
     Memorizzare in una posizione sicura il file di dump, il file di configurazione <filename>/etc/my.cnf</filename> e la directory <filename>/etc/mysql/</filename> per analizzarli in seguito (<emphasis>non</emphasis> per l&apos;installazione!).
    </para>
   </step>
   <step>
    <para>
     Eseguire l&apos;upgrade di <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>. Dopo l&apos;upgrade, il file di configurazione precedente <filename>/etc/my.cnf</filename> resta inalterato. È possibile trovare la nuova configurazione nel file <filename>/etc/my.cnf.rpmnew</filename>.
    </para>
   </step>
   <step>
    <para>
     Configurare il database MariaDB in base alle proprie esigenze. <emphasis>Non</emphasis> utilizzare il file di configurazione e la directory precedenti, utilizzarlo invece come promemoria e adattarlo.
    </para>
   </step>
   <step>
    <para>
     Avviare il server MariaDB:
    </para>
    <screen><prompt role="root"># </prompt><command>systemctl</command> start mariadb</screen>
    <para>
     Se si desidera avviare il server MariaDB a ogni avvio, attivare il servizio:
    </para>
    <screen><prompt role="root"># </prompt><command>systemctl</command> enable mariadb</screen>
   </step>
   <step>
    <para>
     Verificare che MariaDB sia in esecuzione connettendolo al database:
    </para>
    <screen><prompt role="root"># </prompt><command>mariadb</command> -u root -p</screen>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-update-preparation-ssl">
  <title>Creazione di certificati server non MD5 per applicazioni Java</title>
  <remark>toms 2016-07-27: from bsc#970153, c#24</remark>
  <remark>jufa 2021-02-09: FIXME check if still relevant, check which versions are affected</remark>
  <remark>cwickert-2022-07-07: Change occurred during the upgrade from
   java-1_8_0-openjdk-1.8.0.65-1.13 to java-1_8_0-openjdk-1.8.0.72-3.2, means
   for SLES it happened between SLES 12 GA and SP1. So still relevant.
  </remark>
  <para>
   Come misura di sicurezza, i certificati basati su MD5 non sono più supportati in Java. Se sono presenti certificati creati come MD5, ricrearli seguendo la procedura indicata:
  </para>
  <procedure>
   <step>
    <para>
     Aprire un terminale ed eseguire il login come <systemitem class="username">root</systemitem>.
    </para>
   </step>
   <step>
    <para>
     Creare una chiave privata:
    </para>
    <screen><prompt role="root"># </prompt><command>openssl</command> genrsa -out server.key 1024</screen>
    <para>
     Se si desidera una chiave più sicura, sostituire <literal>1024</literal> con un numero più alto, ad esempio, <literal>4096</literal>.
    </para>
   </step>
   <step>
    <para>
     Creare una richiesta di firma del certificato (CSR):
    </para>
    <screen><prompt role="root"># </prompt><command>openssl</command> req -new -key server.key -out server.csr</screen>
   </step>
   <step>
    <para>
     Firmare il certificato:
    </para>
    <screen><prompt role="root"># </prompt><command>openssl</command> x509 -req -days 365 -in server.csr -signkey server.key -out server.crt</screen>
   </step>
   <step>
    <para>
     Creare il file PEM:
    </para>
    <screen><prompt role="root"># </prompt><command>cat</command> server.key server.crt &gt; server.pem</screen>
   </step>
   <step>
    <para>
     Spostare i file <filename>server.crt</filename>, <filename>server.csr</filename>, <filename>server.key</filename> e <filename>server.pem</filename> nelle directory rispettive dove si trovano le chiavi. Per Tomcat, ad esempio, la directory è <filename>/etc/tomcat/ssl/</filename>.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-update-preparation-vms">
  <title>Arresto dei guest delle macchine virtuali</title>

  <para>
   Se il computer funge da server host per macchine virtuali per KVM<phrase os="sles;sled"> o Xen</phrase>, assicurarsi di spegnere correttamente tutti i guest delle macchine virtuali in esecuzione prima dell&apos;aggiornamento. altrimenti l&apos;accesso ai guest dopo l&apos;aggiornamento potrebbe risultare impossibile.
  </para>
 </sect1>
 <sect1 os="sles;sled" xml:id="sec-update-preparation-rmt">
  <title>Regolazione della configurazione del client SMT</title>

  <para>
   Se il computer di cui si desidera effettuare l&apos;upgrade è registrato come client di un server SMT, eseguire le seguenti operazioni:
  </para>

  <para>
   Verificare che la versione dello script <command>clientSetup4SMT.sh</command> sull&apos;host sia aggiornata. <command>clientSetup4SMT.sh</command> dalle versioni precedenti di SMT non è in grado di gestire i client SMT 12. Se si applicano regolarmente patch software sul server SMT, è sempre possibile trovare la versione più recente di <command>clientSetup4SMT.sh</command> in <filename>&lt;SMT_HOSTNAME&gt;/repo/tools/clientSetup4SMT.sh</filename>.
  </para>

  <para>
   Qualora l&apos;upgrade del computer a una versione successiva di <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> risultasse impossibile, annullare la registrazione del computer dal server SMT come descritto nella <xref linkend="pro-sec-update-prep-smt-de-register" xrefstyle="select:label"/>. Riavviare quindi il processo di upgrade.
  </para>

  <procedure xml:id="pro-sec-update-prep-smt-de-register">
   <title>Annullamento della registrazione di un client SUSE Linux Enterprise da un server SMT</title>
   <step>
    <para>
     Eseguire il login sul computer client.
    </para>
   </step>
   <step>
    <para>
     Il passaggio seguente dipende dal sistema operativo del client:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Per SUSE Linux Enterprise 11, eseguire i seguenti comandi:
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> suse_register -E
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/suseRegister*
<prompt>&gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/lastzmdconfig.cache
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zmd/deviceid
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zmd/secret</screen>
     </listitem>
     <listitem>
      <para>
       Per SUSE Linux Enterprise 12, eseguire i seguenti comandi:
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> SUSEConnect --de-register
<prompt>&gt; </prompt><command>sudo</command> SUSEConnect --cleanup
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*</screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Eseguire il login al server SMT.
    </para>
   </step>
   <step>
    <para>
     Verificare che l&apos;annullamento della registrazione del client sia stato completato visualizzando l&apos;elenco di tutte le registrazioni client:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> smt-list-registrations</screen>
   </step>
   <step>
    <para>
     Se il nome host del client risulta ancora nell&apos;output del comando, ottenere l&apos;<literal>Unique ID</literal> dalla prima colonna. (nell&apos;elenco potrebbero essere presenti più ID per il client).
    </para>
   </step>
   <step>
    <para>
     Eliminare la registrazione per il client specificato:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> smt-delete-registration -g <replaceable>UNIQUE_ID</replaceable></screen>
   </step>
   <step>
    <para>
     Se nell&apos;elenco risultano più ID per il client, ripetere il passaggio indicato sopra per ciascun ID univoco.
    </para>
   </step>
   <step>
    <para>
     Verificare che l&apos;annullamento della registrazione del client sia completato eseguendo nuovamente:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> smt-list-registrations</screen>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-autoyast-profiles" os="sles">
  <title>Modifiche nei profili AutoYaST da SLE 12 a 15</title>

  <para>
   Per ulteriori informazioni su come eseguire la migrazione dei profili AutoYaST, consultare il <xref linkend="appendix-ay-12vs15"/>.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-smt-to-rmt" os="sles">
  <title>Upgrade di un server SMT (Subscription Management Tool)</title>

  <para>
   Per un server sul quale è in esecuzione un SMT, è necessaria una procedura di upgrade speciale. Fare riferimento al <xref linkend="cha-rmt-migrate"/> nella Repository Mirroring Tool Guide (Guida allo strumento di mirroring del repository).
  </para>
 </sect1>
 <sect1 os="sles" xml:id="sec-update-preparation-multiversion">
  <title>Disabilitazione temporanea del supporto di più versioni del kernel</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> consente l&apos;installazione di più versioni del kernel, abilitando le impostazioni corrispondenti in <filename>/etc/zypp/zypp.conf</filename>. Per eseguire l&apos;upgrade di un Service Pack, il supporto di tale funzione deve essere temporaneamente disabilitato e può essere nuovamente abilitato al termine dell&apos;aggiornamento. Per disabilitare il supporto di più versioni, trasformare in commento le righe corrispondenti in <filename>/etc/zypp/zypp.conf</filename>. Il risultato deve assomigliare a quello riportato di seguito:
  </para>

<screen>#multiversion = provides:multiversion(kernel)
#multiversion.kernels = latest,running</screen>

  <para>
   Per riattivare la funzione al termine dell&apos;aggiornamento, rimuovere i segni di commento. Per ulteriori informazioni sul supporto di più versioni, vedere <xref linkend="sec-tuning-multikernel-enable"/>.
  </para>
 </sect1>
 <sect1 xml:id="sec-upgrade-prepare-boot-config">
  <title>Regolazione del parametro di avvio <literal>resume</literal></title>
  <para>
   Sui sistemi installati con <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 12 o versioni precedenti, la riga di comando di default del kernel in <filename>/etc/default/grub</filename> può contenere un parametro <parameter>resume</parameter> che utilizza un nome di nodo del dispositivo come <filename>/dev/sda1</filename> per fare riferimento al dispositivo di ibernazione (sospensione su disco). Poiché i nomi di nodi del dispositivo non sono persistenti e potrebbero cambiare tra un riavvio e l&apos;altro, si consiglia vivamente di risolvere questo problema. In caso contrario, il sistema di cui si è eseguito l&apos;upgrade potrebbe bloccarsi al riavvio.
  </para>
  <procedure>
   <step>
    <para>
     Trovare il dispositivo di ibernazione:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>grep resume /etc/default/grub</command>
GRUB_CMDLINE_LINUX_DEFAULT="resume=/dev/sda1 splash=silent quiet showopts"
</screen>
    <para>
     Il dispositivo di ibernazione è <filename>/dev/sda1</filename>. Se il comando non restituisce alcun valore, l&apos;ibernazione non è configurata.
    </para>
   </step>
   <step>
    <para>
     Ottenere l&apos;UUID per <filename><replaceable>/dev/sda1</replaceable></filename>:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>blkid /dev/vda1</command>
/dev/vda1: UUID="a1d1f2e0-b0ee-4be2-83d5-78a98c585827" TYPE="swap" PARTUUID="000134b5-01"</screen>
    <para>
     L&apos;UUID per <filename>/dev/sda1</filename> è <literal>a1d1f2e0-b0ee-4be2-83d5-78a98c585827</literal>.
    </para>
   </step>
   <step>
    <para>
     Modificare <filename>/etc/default/grub</filename> e regolare il parametro <parameter>resume</parameter>. Sostituire <literal><replaceable>/dev/sda1</replaceable></literal> con <literal><replaceable>UUID=a1d1f2e0-b0ee-4be2-83d5-78a98c585827</replaceable></literal>. Il risultato deve essere simile al seguente:
    </para>
<screen>GRUB_CMDLINE_LINUX_DEFAULT="resume=UUID=a1d1f2e0-b0ee-4be2-83d5-78a98c585827 splash=silent quiet showopts"</screen>
   </step>
   <step>
    <para>
     Aggiornare la configurazione del boot manager grub:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>grub2-mkconfig -o /boot/grub2/grub.cfg</command></screen>
   </step>
  </procedure>
  <para>
   Se il sistema non utilizza l&apos;ibernazione, è possibile rimuovere il parametro <parameter>resume</parameter> e aggiornare la configurazione di avvio.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-zseries" os="sles">
  <title>Upgrade su IBM Z</title>

  <para>
   Per l&apos;upgrade di un&apos;installazione SUSE Linux Enterprise su IBM Z necessario il parametro del kernel <command>Upgrade=1</command>, ad esempio tramite parmfile. Vedere <xref linkend="sec-appdendix-parm"/>.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-ppc" os="sles" arch="power">
  <title>IBM POWER: avvio di un server X</title>

  <para>
   In SLES 12 per IBM POWER, per impostazione predefinita il display manager è configurato in modo che non venga avviato un server X locale. In SLES 12 SP1 tale impostazione è stata invertita e ora il display manager avvia un server X.
  </para>

  <para>
   Per evitare problemi durante l&apos;upgrade, l&apos;impostazione di <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> non viene modificata automaticamente. Affinché il display manager avvii un server X dopo l&apos;upgrade, modificare come segue l&apos;impostazione <envar>DISPLAYMANAGER_STARTS_XSERVER</envar> in <filename>/etc/sysconfig/displaymanager</filename>:
  </para>

<screen>DISPLAYMANAGER_STARTS_XSERVER="yes"</screen>
 </sect1>
</chapter>
