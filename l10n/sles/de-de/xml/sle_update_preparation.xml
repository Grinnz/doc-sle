<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_preparation.xml" version="5.0" xml:id="cha-update-preparation">
 <title>Vorbereiten des Upgrades</title>
 <info>
  <abstract>
   <para>
    Vor Beginn des Upgrades muss das System ordnungsgemäß vorbereitet werden. Zur Vorbereitung gehören unter anderem das Sichern der Daten und das Lesen der Versionshinweise. Im folgenden Kapitel werden Sie durch diese Schritte geführt.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <remark>jufa 2021-02-09: suggestion to give this chapter a facelift:
 Chapter 3: Preparing the upgrade - Intro - Procedure w check system version,
 release notes, back-up, listing packages, create proposal</remark>
 

 <sect1 xml:id="sec-update-preparation-update">
  <title>Prüfen, ob das System auf dem neuesten Stand ist</title>

  <para os="sles;sled">
   <remark>jufa 2021-02-09: add what to do if the system is older? check what
    is meant with patch level. check if update path is supported,
    link to sec-upgrade-path-supported</remark>
   Ein Upgraden des Systems wird nur von der jeweils letzten Patch-Stufe aus unterstützt. Prüfen Sie, ob die neuesten Systemaktualisierungen installiert sind. <phrase os="sles;sled">Führen Sie hierzu entweder</phrase> <command>zypper
   patch</command><phrase os="sles;sled"> aus oder starten Sie das YaST-Modul <guimenu>Online-Update</guimenu></phrase>.
  </para>

  


    <note os="sles;sled" xml:id="new-4096-bit-rpm-key">
      <title>Neuer 4096-Bit-Signierschlüssel für SUSE Linux Enterprise 15</title>
      <para>
        Mitte 2023 wurde die SUSE Linux Enterprise 15 Produktfamilie von einem RSA 2048-Bit-Signierschlüssel auf einen neuen RSA 4096-Bit-Schlüssel umgestellt. Diese Änderung betrifft RPM-Pakete, Paket-Repositorys und ISO-Signaturen. Alte Repositorys, die nicht mehr aktualisiert werden, und RPMs, die bis zum Zeitpunkt der Umstellung veröffentlicht wurden, bleiben mit dem alten 2048-Bit-Schlüssel signiert.
      </para>
      <para>
        Wenn Sie Ihr System aktualisieren, wird der neue Schlüssel automatisch in den RPM-Schlüsselring aus dem <package>suse-build-key</package>-Paket auf SLE 15 SP 4 und SP5 sowie den LTSS-Versionen von SLE 15 SP1, SP2 und SP3 importiert.
      </para>
      <para>
        Wenn der Schlüssel noch nicht importiert wurde, können Sie ihn manuell importieren mit:
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>rpm --import /usr/lib/rpm/gnupg/keys/gpg-pubkey-3fa1d6ce-63c9481c.asc</command></screen>
      <para>
        Wenn Sie eine ältere Version von SLE verwenden oder den neuen Schlüssel nicht importiert haben, werden Sie während des Upgrades aufgefordert, ihm zu vertrauen. Versichern Sie sich, dass der Fingerabdruck übereinstimmt:
      </para>
<screen>pub   rsa4096/0xF74F09BC3FA1D6CE 2023-01-19 [SC] [expires: 2027-01-18]
Key fingerprint = 7F00 9157 B127 B994 D5CF  BE76 F74F 09BC 3FA1 D6CE
uid           SUSE Package Signing Key &lt;build@suse.de&gt;</screen>
      <para>
        Zusätzlich wurde ein 4096-Bit-RSA-Reserveschlüssel für Disaster Recovery-Zwecke importiert:
      </para>
<screen>pub   rsa4096/0xA1BFC02BD588DC46 2023-01-19 [SC] [expires: 2033-01-16]
Key fingerprint = B56E 5601 41D8 F654 2DFF  3BF9 A1BF C02B D588 DC46
uid           SUSE Package Signing Key (reserve key) &lt;build@suse.de&gt;</screen>
      <para>
        Dieser Schlüssel kann manuell importiert werden mit:
      </para>
      <screen><prompt>&gt; </prompt><command>sudo</command> <command>rpm --import /usr/lib/rpm/gnupg/keys/gpg-pubkey-d588dc46-63c939db.asc</command></screen>
      <para>
        Beide Schlüssel finden Sie auch auf dem Installationsmedium und auf der SUSE-Website unter <link xlink:href="https://www.suse.com/support/security/keys/"/>.
      </para>
    </note>

 </sect1>
 <sect1 xml:id="sec-update-preparation-relnotes">
  <title>Lesen Sie die Versionshinweise</title>

  <para>
   Eine Liste aller Änderungen, neuen Funktionen und bekannten Probleme finden Sie in den <link xlink:href="https://www.suse.com/releasenotes/">release notes</link>. Die Versionshinweise finden Sie auch auf den Installationsmedien im Verzeichnis <filename>docu</filename>.
  </para>

  <para>
   Die Versionshinweise enthalten in der Regel nur die Änderungen zwischen zwei aufeinander folgenden Versionen. <phrase os="sles;sled">Falls Sie mindestens ein Service Pack überspringen, beachten Sie auch die Versionshinweise der übersprungenen Service Packs.</phrase>
  </para>

  <para>
   Lesen Sie die Versionshinweise, um zu prüfen, ob Folgendes zutrifft:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Sind bei der Hardware besondere Überlegungen zu beachten?
    </para>
   </listitem>
   <listitem>
    <para>
     Wurden erhebliche Änderungen an den aktuell verwendeten Softwarepaketen vorgenommen?
    </para>
   </listitem>
   <listitem>
    <para>
     Erfordert Ihre Installation besondere Vorsichtsmaßnahmen?
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec-update-preparation-backup">
  <title>Eine Sicherung erstellen</title>

  <para>
   Sichern Sie vor dem Upgrade Ihre Daten, indem Sie die vorhandenen Konfigurationsdateien auf ein separates Medium (z. B. Bandgerät, externe Festplatte usw.) kopieren. Dies gilt hauptsächlich für die in <filename>/etc</filename> gespeicherten Dateien sowie für bestimmte Verzeichnisse und Dateien in <filename>/var</filename> und <filename>/opt</filename>. Zudem empfiehlt es sich, die Benutzerdaten in <filename>/home</filename> (den <envar>HOME</envar>-Verzeichnissen) auf ein Sicherungsmedium zu schreiben.
  </para>

  <para>
   Melden Sie sich zur Sicherung dieser Daten als <systemitem class="username">root</systemitem> an. Nur der Benutzer <systemitem class="username">root</systemitem> verfügt über die Berechtigungen für alle lokalen Dateien.
  </para>

  <para os="sles;sled">
   <remark>jufa 2021-02-09: check if backup function still exists and how it
    works. rework para accordingly: alternative for data back up</remark>
   Wenn Sie in YaST den Installationsmodus <guimenu>Vorhandenes System aktualisieren</guimenu> ausgewählt haben, können Sie später wahlweise eine (System-)Sicherung ausführen. Sie können alle geänderten Dateien und die Dateien aus dem Verzeichnis <filename>/etc/sysconfig</filename> einschließen. Dies ist allerdings keine vollständige Sicherung, da alle anderen wichtigen, oben genannten Verzeichnisse außer Acht gelassen werden. Die Sicherungskopie befindet sich im Verzeichnis <filename>/var/adm/backup</filename>.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-disk">
  <title>Verfügbaren Speicherplatz prüfen</title>

  <para>
   Software weist normalerweise von Version zu Version mehr Umfang auf. Folglich sollten Sie vor dem Aktualisieren den verfügbaren Partitionsspeicher überprüfen. Wenn Sie befürchten, dass der Speicherplatz nicht ausreicht, sichern Sie Ihre Daten und erhöhen Sie dann den verfügbaren Speicherplatz, indem Sie beispielsweise die Größe von Partitionen ändern. Es gibt keine Faustregel hinsichtlich des Speicherplatzes einzelner Partitionen. Die Platzanforderungen hängen von Ihrem bestimmten Partitionsprofil und von der ausgewählten Software ab.
  </para>

  <note os="sles;sled">
   <title>Automatische Prüfung des verfügbaren Speicherplatzes in YaST</title>
   <para>
    YaST prüft während des Aktualisierungsvorgangs den freien verfügbaren Speicherplatz und zeigt dem Benutzer eine Warnmeldung an, wenn die verfügbare Menge möglicherweise nicht für die Installation ausreicht. Wenn Sie die Aktualisierung in diesem Fall dennoch durchführen, kann das <emphasis>System unbrauchbar</emphasis> werden! Sie sollten die Warnmeldung nur dann ignorieren und mit der Aktualisierung fortfahren, wenn Sie genau wissen, was Sie tun (da Sie dies in einem Vorabtest abgeklärt haben).
   </para>
  </note>

  <sect2 os="sles;sled" xml:id="sec-update-preparation-disk-space">
   <title>Ermitteln des freien Speicherplatzes auf Nicht-Btrfs-Dateisystemen</title>
   <para>
    Listen Sie mit dem Kommando <command>df</command> den verfügbaren Speicherplatz auf. In <xref linkend="ex-update-df"/> ist beispielsweise <filename>/dev/sda3</filename> die root-Partition (eingehängt als <filename>/</filename>).
   </para>
   <example xml:id="ex-update-df">
    <title>Über <command>df -h</command> angezeigte Liste</title>
    
    <screen os="sles">Filesystem     Size  Used Avail Use% Mounted on
     /dev/sda3       74G   22G   53G  29% /
     tmpfs          506M     0  506M   0% /dev/shm
     /dev/sda5      116G  5.8G  111G   5% /home
     /dev/sda1       44G    4G   40G   9% /data</screen>
   </example>
  </sect2>

  <sect2 xml:id="sec-update-preparation-disk-btrfs-on-root">
   <title>Ermitteln des freien Speicherplatzes auf Btrfs-root-Dateisystemen</title>
   
   <para>
    In einem Btrfs-Dateisystem kann die Ausgabe von <command>df</command> irreführend sein, weil ein Btrfs-Dateisystem zusätzlich zum Speicherplatz, den die Rohdaten zuordnen, auch Speicherplatz für Metadaten zuordnet und verwendet.
   </para>
   <para>
    Folglich meldet ein Btrfs-Dateisystem womöglich, dass es keinen Speicherplatz mehr hat, obwohl anscheinend noch genügend vorhanden ist. In diesem Fall ist der gesamte Speicherplatz, der den Metadaten zugeordnet ist, belegt. <phrase os="sles">Details zur Überprüfung des belegten und verfügbaren Speicherplatzes auf einem Btrfs-Dateisystem finden Sie im <xref linkend="sec-filesystems-major-btrfs-suse-space"/>&#x002E;</phrase> Weitere Informationen finden Sie unter <phrase os="sles;sled"><command>man 8
     btrfs-filesystem</command> und </phrase><link xlink:href="https://btrfs.wiki.kernel.org/index.php/FAQ"/>.
   </para>
   
   <para os="sles;sled">
    Wenn Sie Btrfs als root-Dateisysteme auf dem Rechner nutzen, muss ausreichend freier Speicherplatz zur Verfügung stehen. Prüfen Sie den verfügbaren Speicherplatz auf allen eingehängten Partitionen. Im schlimmsten Fall belegt ein Upgrade ebenso viel Speicherplatz wie das aktuelle root-Dateisystem (ohne <filename>/.snapshot</filename>) für einen neuen Snapshot.
   </para>
   
   <para>
    Die folgenden Empfehlungen haben sich bewährt:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Bei allen Dateisystemen (auch Btrfs) benötigen Sie ausreichend freien Speicherplatz, damit Sie große RPMs herunterladen und installieren können. Der Speicherplatz der alten RPMs wird erst dann freigegeben, wenn die neuen RPMs installiert sind.
     </para>
    </listitem>
    <listitem>
     <para>
      Bei Btrfs mit Snapshots benötigen Sie mindestens so viel freien Speicherplatz, wie von der aktuellen Installation belegt wird. Es wird mindestens der doppelte freie Speicherplatz empfohlen, wie von der aktuellen Installation belegt wird.
     </para>
     <para>
      Falls nicht ausreichend freier Speicherplatz verfügbar ist, können Sie ältere Snapshots mit <command>snapper</command> löschen:
     </para>
     <screen><prompt role="root"># </prompt><command>snapper</command> list
      <prompt role="root"># </prompt><command>snapper</command> delete NUMBER</screen>
     <para>
      Dies reicht jedoch nicht in allen Fällen aus. Vor der Migration belegen die meisten Snapshots nur wenig Platz.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-update-preparation-packagelist">
  <title>Auflisten installierter Pakete und Repositorys</title>

  <para>
   <remark>jufa 2021-02-08: explain importance and purposeof this list.
    Clarify if requirement or suggestion?
    Used for reverting changes or to set-up new system?</remark>
   Sie können eine Liste der installierten Pakete speichern; beispielsweise bei einer Neuinstallation einer neuen SLE-Hauptversion oder beim Zurücksetzen des Systems auf die bisherige Version.
  </para>

  <note>
   <para>
    <remark>jufa: check if manual editing is still relevant 2021-02-09</remark>
    Denken Sie daran, dass nicht alle installierten Pakete oder verwendeten Repositorys in neueren Versionen von SUSE Linux Enterprise vorliegen. Einige Elemente wurden unter Umständen umbenannt, andere ersetzt. Außerdem könnten bestimmte Pakete weiterhin zu Legacy-Zwecken verfügbar sein, während standardmäßig ein anderes Paket herangezogen wird. Aus diesem Grund müssen die Dateien ggf. manuell bearbeitet werden. Dies können Sie mit einem beliebigen Texteditor durchführen.
   </para>
  </note>

  <procedure>
   <step>
    <para>
     Erstellen Sie die Datei <filename>repositories.bak.repo</filename> mit einer Liste aller verwendeten Repositorys.
    </para>
<screen><prompt role="root"># </prompt><command>zypper</command> lr -e repositories.bak</screen>
   </step>
   <step>
    <para>
     Erstellen Sie außerdem die Datei <filename>installed-software.bak</filename> mit einer Liste aller installierten Pakete:
    </para>
<screen><prompt role="root"># </prompt><command>rpm</command> -qa --queryformat '%{NAME}\n' &gt;
     installed-software.bak</screen>
   </step>
   <step>
    <para>
     Erstellen Sie Sicherungskopien beider Dateien. Die Repositorys und die installierten Pakete können mit den folgenden Befehlen wiederhergestellt werden:
    </para>
<screen os="sles;sled"><prompt role="root"># </prompt><command>zypper</command> ar repositories.bak.repo
<prompt role="root"># </prompt><command>zypper</command> install $(cat installed-software.bak)
</screen>

    <note os="sles;sled" xml:id="note-update-prep-backup-package-amount">
     <title>Bei einer Aktualisierung auf eine neue Hauptversion erhöht sich die Anzahl der Pakete</title>
     <para>
      Ein System, das auf eine neue Hauptversion upgegradet wurde (SLE <replaceable>X+1</replaceable>), enthält eventuell mehr Pakete als das ursprüngliche System (SLE <replaceable>X</replaceable>). Die Anzahl der Pakete ist außerdem höher als bei einer Neuinstallation von SLE <replaceable>X+1</replaceable> mit derselben Schemaauswahl. Hierfür sind folgende Gründe zu nennen:
     </para>
     <itemizedlist>
      <listitem>
       <para>
        Die Pakete wurden aufgeteilt, sodass Sie die gewünschte Paketauswahl noch genauer festlegen können. Beispielsweise wurden 37 <package>texlive</package>-Pakete aus SLE 11 auf mehr als 3000 Pakete in SLE 15 aufgeteilt.
       </para>
      </listitem>
      <listitem>
       <para>
        Wenn ein Paket aufgeteilt wurde, werden bei einem Upgrade alle neuen Pakete installiert, damit in jedem Fall derselbe Funktionsumfang wie in der früheren Version zur Verfügung steht. Bei einer Neuinstallation von SLE <replaceable>X+1</replaceable> werden jedoch unter Umständen nicht mehr alle Pakete standardmäßig installiert.
       </para>
      </listitem>
      <listitem>
       <para>
        Ältere Pakete aus SLE <replaceable>X</replaceable> werden ggf. aus Kompatibilitätsgründen beibehalten.
       </para>
      </listitem>
      <listitem>
       <para>
        Die Paketabhängigkeiten und der Schemaumfang haben sich unter Umständen geändert.
       </para>
      </listitem>
     </itemizedlist>
    </note>
    
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-update-preparation-ltss">
  <title>LTSS-Erweiterung deaktivieren</title>
  <para>
   Wenn Sie ein <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>-System mit LTSS (Long Term Service Pack Support) auf eine Version aktualisieren, die noch unter allgemeinem Support steht, schlägt das Upgrade mit dem Fehler <literal>No migration available</literal> fehl. Dies geschieht, weil <command>zypper migration</command> versucht, <emphasis>alle</emphasis> Repositorys zu migrieren, es aber noch kein LTSS-Repository für die neue Version gibt.
  </para>
  <para>
   Deaktivieren Sie zur Behebung dieses Problems die LTSS-Erweiterung vor dem Upgrade.
  </para>
  <procedure>
   <step>
    <para>
     Prüfen Sie, ob die LTSS-Erweiterung aktiviert ist:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> SUSEConnect --list-extensions | grep LTSS
SUSE Linux Enterprise Server LTSS 12 SP4 x86_64 (Installed)
Deactivate with: SUSEConnect -d -p SLES-LTSS/12.4/x86_64</screen>
   </step>
   <step>
    <para>
     Deaktivieren Sie die LTSS-Erweiterung mit dem Befehl aus der <command>SUSEConnect</command>-Ausgabe oben:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> SUSEConnect -d -p SLES-LTSS/12.4/x86_64
Deregistered SUSE Linux Enterprise Server LTSS 12 SP4 x86_64
To server: https://scc.suse.com/</screen>
   </step>
   <step>
    <para>
     Prüfen Sie, ob das LTSS-Repository bei <command>zypper lr</command> nicht mehr vorhanden ist.
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 os="sles" xml:id="sec-update-preparation-postgresql">
  <title>Migration der PostgreSQL-Datenbank</title>

  <para>
   
   Im Lieferumfang von <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> <phrase role="productnumber"><phrase os="sles;sled">15 SP6</phrase></phrase> sind die PostgreSQL-Datenbankversionen 14 und 15 enthalten. Version 15 ist die Standardversion. Version 14 wird weiterhin über das <literal>Legacy</literal>-Modul für Upgrades von früheren Versionen von <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> bereitgestellt.
  </para>

  <para>
   Aufgrund der erforderlichen Migrationsschritte für die Datenbank ist kein automatischer Upgradevorgang verfügbar. Die Umstellung auf die neue Version muss daher manuell erfolgen.
  </para>

  <para>
   Der Migrationsvorgang wird mit dem Kommando <command>pg_upgrade</command> ausgeführt. Dieses Kommando ist eine alternative Methode zur bewährten Methode eines Dumps und Neuladens. Im Vergleich zu <quote>Dump und Neuladen</quote> ist die Migration mit <command>pg_upgrade</command> weniger zeitaufwändig.
  </para>

  <para>
   Die Programmdateien aller PostgreSQL-Versionen werden in unterschiedlichen, versionsabhängigen Verzeichnissen abgelegt. Beispielsweise in <filename>/usr/lib/postgresql96/</filename> für Version 9.6, in <filename>/usr/lib/postgresql10/</filename> für Version 10 und in <filename>/usr/lib/postgres13/</filename> für Version 13. Beachten Sie, dass sich die Versionsrichtlinien von PostgreSQL zwischen den Hauptversionen 9.6 und 10 geändert haben. Weitere Informationen finden Sie im <link xlink:href="https://www.postgresql.org/support/versioning/"/>.
  </para>

  <important>
   <title>Aufrüstung von SLE 11</title>
   <para>
    Wenn Sie von SLE 11 aufrüsten, wird <systemitem>postgresql94</systemitem> nicht deinstalliert und kann nicht für die Datenbankmigration zu einer höheren PostgreSQL-Version verwendet werden. Stellen Sie in diesem Fall also sicher, dass Sie die PostgreSQL-Datenbank <emphasis>vor</emphasis> dem Upgrade des Systems migrieren.
   </para>
  </important>

  <para>
   Im unten geschilderten Verfahren finden Sie die Schritte für die Datenbankmigration von Version 12 zu Version 13. Werden als Ausgangspunkt oder Ziel andere Versionen verwendet, ersetzen Sie die Versionsnummern entsprechend.
  </para>

  <para>
   So führen Sie die Datenbankmigration aus:
  </para>

  <procedure>
   <step>
    <para>
     Prüfen Sie, ob die folgenden Voraussetzungen erfüllt sind:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Upgraden Sie alle Pakete der alten PostgreSQL-Version per Wartungsaktualisierung auf die aktuelle Version, sofern Sie dies noch nicht erledigt haben.
      </para>
     </listitem>
     <listitem>
      <para>
       Erstellen Sie eine Sicherung der vorhandenen Datenbank.
      </para>
     </listitem>
     <listitem>
      <para>
       Installieren Sie die Pakete der neuen PostgreSQL-Hauptversion. Für SLE 15 SP6 bedeutet dies die Installation von <package>postgresql13-server</package> und aller Pakete, von denen diese PostgreSQL-Version abhängt.
      </para>
     </listitem>
     <listitem>
      <para>
       Installieren Sie das Paket <package>postgresql13-contrib</package>, das das Kommando <command>pg_upgrade</command> enthält.
      </para>
     </listitem>
     <listitem>
      <para>
       Prüfen Sie, ob ausreichend freier Speicherplatz im PostgreSQL-Datenbereich verfügbar ist (standardmäßig <filename>/var/lib/pgsql/data</filename>). Falls der Speicherplatz nicht ausreicht, versuchen Sie, die einzelnen Datenbanken mit dem folgenden SQL-Kommando zu verkleinern (kann sehr lange dauern):
      </para>
<screen>VACUUM FULL</screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Halten Sie den PostgreSQL-Server mit einer der folgenden Optionen an:
    </para>
<screen><prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
    <para>
     oder
    </para>
<screen><prompt role="root"># </prompt>systemctl stop postgresql.service</screen>
    <para>
     (abhängig von der SLE-Version, die Sie als Ausgangsversion des Upgrades nutzen).
    </para>
   </step>
   <step>
    <para>
     Benennen Sie das alte Datenverzeichnis um:
    </para>
<screen><prompt role="root"># </prompt><command>mv</command> /var/lib/pgsql/data /var/lib/pgsql/data.old</screen>
   </step>
   <step>
    <para>
     Initialisieren Sie die neue Datenbankinstanz manuell mit <command>initdb</command> oder starten und stoppen Sie PostgreSQL, wodurch die Instanz automatisch initialisiert wird:
    </para>
<screen><prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> start
<prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
    <para>
     oder
    </para>
<screen><prompt role="root"># </prompt>systemctl start postgresql.service
<prompt role="root"># </prompt>systemctl stop postgresql.service</screen>
    <para>
     (abhängig von der SLE-Version, die Sie als Ausgangsversion des Upgrades nutzen).
    </para>
   </step>
   <step>
    <para>
     Sollten Sie in der alten Version die Konfigurationsdateien bearbeitet haben, ziehen Sie in Betracht, diese Änderungen in die neuen Konfigurationsdateien zu übernehmen. Dieser Umstand könnte sich auf die Dateien <filename>postgresql.auto.conf</filename>, <filename>postgresql.conf</filename>, <filename>pg_hba.conf</filename> und <filename>pg_ident.conf</filename> auswirken. Die alten Versionen dieser Dateien befinden sich in <filename>/var/lib/pgsql/data.old/</filename>, die neuen Versionen in <filename>/var/lib/pgsql/data</filename>.
    </para>
    <para>
     Beachten Sie, dass wir nicht empfehlen, die alten Konfigurationsdateien zu kopieren, da so möglicherweise neue Optionen, neue Standardeinstellungen und geänderte Kommentare überschrieben werden.
    </para>
   </step>
   <step>
    <para>
     Beginnen Sie als Benutzer <systemitem class="username">postgres</systemitem> mit der Migration:
    </para>
<screen><prompt role="root"># </prompt>su - postgres
postgres &gt; <command>pg_upgrade</command> \
 --old-datadir "/var/lib/pgsql/data.old" \
 --new-datadir "/var/lib/pgsql/data" \
 --old-bindir "/usr/lib/postgresql12/bin/" \
 --new-bindir "/usr/lib/postgresql13/bin/"</screen>
   </step>
   <step>
    <para>
     Starten Sie Ihre neue Datenbank über eine der folgenden Optionen:
    </para>
<screen><prompt role="root"># </prompt><command>/usr/sbin/rcpostgresql</command> start</screen>
    <para>
     oder
    </para>
<screen><prompt role="root"># </prompt>systemctl start postgresql.service</screen>
    <para>
     (abhängig von der SLE-Version, die Sie als Ausgangsversion des Upgrades nutzen).
    </para>
   </step>
   <step>
    <para>
     Überprüfen Sie, ob die Migration erfolgreich war. Der Testumfang hängt von Ihrem Anwendungsfall ab. Zur Automatisierung dieses Schritts steht kein allgemeines Tool zur Verfügung.
    </para>
   </step>
   <step>
    <para>
     Entfernen Sie alle alten PostgreSQL-Pakete und das alte Datenverzeichnis:
    </para>
<screen><prompt role="root"># </prompt><command>zypper</command> search -s postgresql12| xargs zypper rm -u
<prompt role="root"># </prompt><command>rm</command> -rf /var/lib/pgsql/data.old</screen>
   </step>
  </procedure>

  <para>
   Weitere Informationen zum Upgrade von Datenbanken oder zur Verwendung alternativer Methoden wie der logischen Reproduktion finden Sie in der offiziellen PostgreSQL-Dokumentation unter <link xlink:href="https://www.postgresql.org/docs/13/upgrading.html"/>.
  </para>
 </sect1>

 <sect1 os="sles" xml:id="sec-update-preparation-mariadb">
  <title>Migration der MySQL- oder MariaDB-Datenbank</title>
  <remark>toms 2015-09-03: already reviewed by Ondrej and Kristýna.</remark>
  <para>
   Ab SUSE Linux Enterprise 12 hat SUSE von MySQL auf MariaDB umgestellt. Bevor Sie das Upgrade starten, wird dringend empfohlen, die Datenbank zu sichern.
  </para>
  <para>
   So führen Sie die Datenbankmigration aus:
  </para>
  <procedure>
   <step>
    <para>
     Erstellen Sie eine Dump-Datei:
    </para>
    <remark>cwickert 2022-07-07: '--add-drop-database' is required for <link xlink:href="https://bugzilla.suse.com/show_bug.cgi?id=1166786">BSC#1166786</link>&#x002E;</remark>
    <screen><prompt role="root"># </prompt><command>mysqldump</command> -u root -p --all-databases --add-drop-database &gt; mysql_backup.sql</screen>
    <para>
     Standardmäßig wird die Datenbank <command>mysqldump</command> oder <literal>INFORMATION_SCHEMA</literal> nicht im Speicherauszug mit <literal>performance_schema</literal> berücksichtigt. Weitere Informationen finden Sie im <link xlink:href="https://mariadb.com/kb/en/mariadb-dumpmysqldump/"/>.
    </para>
   </step>
   <step>
    <para>
     Speichern Sie Ihre Dump-Datei, die Konfigurationsdatei <filename>/etc/my.cnf</filename> sowie das Verzeichnis <filename>/etc/mysql/</filename> an einem sicheren Speicherort, um sie später als Referenz (<emphasis>nicht</emphasis> zur Installation) zu verwenden .
    </para>
   </step>
   <step>
    <para>
     Führen Sie das Upgrade von <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> durch. Nach dem Upgrade ist die bisherige Konfigurationsdatei <filename>/etc/my.cnf</filename> unverändert. Die neue Konfiguration finden Sie in der Datei <filename>/etc/my.cnf.rpmnew</filename>.
    </para>
   </step>
   <step>
    <para>
     Konfigurieren Sie die MariaDB-Datenbank je nach Bedarf. Bearbeiten Sie dabei <emphasis>nicht</emphasis> die bisherige Konfigurationsdatei und das frühere Verzeichnis, sondern nutzen Sie diese nur als Vorlage, und passen Sie die Einstellungen entsprechend an.
    </para>
   </step>
   <step>
    <para>
     Starten Sie den MariaDB-Server:
    </para>
    <screen><prompt role="root"># </prompt><command>systemctl</command> start mariadb</screen>
    <para>
     Soll der MariaDB-Server bei jedem Booten gestartet werden, aktivieren Sie den Dienst:
    </para>
    <screen><prompt role="root"># </prompt><command>systemctl</command> enable mariadb</screen>
   </step>
   <step>
    <para>
     Prüfen Sie, ob MariaDB ordnungsgemäß ausgeführt wird. Stellen Sie hierzu eine Verbindung zur Datenbank her:
    </para>
    <screen><prompt role="root"># </prompt><command>mariadb</command> -u root -p</screen>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-update-preparation-ssl">
  <title>Erstellen von Nicht-MD5-Server-Zertifikaten für Java-Anwendungen</title>
  <remark>toms 2016-07-27: from bsc#970153, c#24</remark>
  <remark>jufa 2021-02-09: FIXME check if still relevant, check which versions are affected</remark>
  <remark>cwickert-2022-07-07: Change occurred during the upgrade from
   java-1_8_0-openjdk-1.8.0.65-1.13 to java-1_8_0-openjdk-1.8.0.72-3.2, means
   for SLES it happened between SLES 12 GA and SP1. So still relevant.
  </remark>
  <para>
   Als Sicherheitsmaßnahme werden MD5-gestützte Zertifikate in Java nicht mehr unterstützt. Wenn Sie über als MD5 erstellte Zertifikate verfügen, erstellen Sie diese mit folgenden Schritten neu:
  </para>
  <procedure>
   <step>
    <para>
     Öffnen Sie ein Terminal und melden Sie sich als <systemitem class="username">root</systemitem> an.
    </para>
   </step>
   <step>
    <para>
     Erstellen Sie einen privaten Schlüssel:
    </para>
    <screen><prompt role="root"># </prompt><command>openssl</command> genrsa -out server.key 1024</screen>
    <para>
     Wenn Sie einen Schlüssel mit höherer Sicherheit wünschen, ersetzen Sie <literal>1024</literal> durch eine höhere Zahl, z. B. <literal>4096</literal>.
    </para>
   </step>
   <step>
    <para>
     Erstellen Sie einen Zertifizierungsantrag (CSR):
    </para>
    <screen><prompt role="root"># </prompt><command>openssl</command> req -new -key server.key -out server.csr</screen>
   </step>
   <step>
    <para>
     Führen Sie eine Eigensignierung des Zertifikats durch:
    </para>
    <screen><prompt role="root"># </prompt><command>openssl</command> x509 -req -days 365 -in server.csr -signkey server.key -out server.crt</screen>
   </step>
   <step>
    <para>
     Erstellen Sie die PEM-Datei:
    </para>
    <screen><prompt role="root"># </prompt><command>cat</command> server.key server.crt &gt; server.pem</screen>
   </step>
   <step>
    <para>
     Legen Sie die Dateien <filename>server.crt</filename>, <filename>server.csr</filename>, <filename>server.key</filename> und <filename>server.pem</filename> in den jeweiligen Verzeichnissen ab, in denen die Schlüssel gefunden werden können. Für Tomcat beispielsweise lautet das Verzeichnis <filename>/etc/tomcat/ssl/</filename>.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-update-preparation-vms">
  <title>Herunterfahren von VM-Gästen</title>

  <para>
   Wenn Ihr Rechner als VM-Hostserver für KVM<phrase os="sles;sled"> oder Xen</phrase> fungiert, müssen Sie vor der Aktualisierung alle aktiven VM-Gäste ordnungsgemäß herunterfahren. Andernfalls können Sie nach der Aktualisierung wahrscheinlich nicht mehr auf die Gäste zugreifen.
  </para>
 </sect1>
 <sect1 os="sles;sled" xml:id="sec-update-preparation-rmt">
  <title>Einrichtung Ihres SMT-Clients anpassen</title>

  <para>
   Beachten Sie Folgendes, wenn der Rechner, für den ein Upgrade durchgeführt werden soll, als Client bei einem SMT-Server registriert ist:
  </para>

  <para>
   Prüfen Sie, ob die Version des Skripts <command>clientSetup4SMT.sh</command> auf Ihrem Host aktuell ist. <command>clientSetup4SMT.sh</command> aus älteren Versionen von SMT kann nicht zum Verwalten von SMT 12-Clients verwendet werden. Wenn Sie auf Ihrem SMT-Server regelmäßig Software-Patches anwenden, finden Sie die neueste Version von <command>clientSetup4SMT.sh</command> immer unter <filename>&lt;SMT_HOSTNAME&gt;/repo/tools/clientSetup4SMT.sh</filename>.
  </para>

  <para>
   Falls das Upgrade Ihres Rechners auf eine höhere Version von <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> nicht ausgeführt werden kann, heben Sie die Registrierung des Rechners beim SMT-Server wie in <xref linkend="pro-sec-update-prep-smt-de-register" xrefstyle="select:label"/> beschrieben auf. Starten Sie danach den Upgradevorgang neu.
  </para>

  <procedure xml:id="pro-sec-update-prep-smt-de-register">
   <title>Aufheben einer Registrierung von SUSE Linux Enterprise Client bei einem SMT-Server</title>
   <step>
    <para>
     Melden Sie sich beim Client-Rechner an.
    </para>
   </step>
   <step>
    <para>
     Der folgende Schritt hängt vom aktuellen Betriebssystem des Client ab:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Für SUSE Linux Enterprise 11 führen Sie folgende Kommandos aus:
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> suse_register -E
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/suseRegister*
<prompt>&gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/lastzmdconfig.cache
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zmd/deviceid
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zmd/secret</screen>
     </listitem>
     <listitem>
      <para>
       Für SUSE Linux Enterprise 12 führen Sie folgende Kommandos aus:
      </para>
<screen><prompt>&gt; </prompt><command>sudo</command> SUSEConnect --de-register
<prompt>&gt; </prompt><command>sudo</command> SUSEConnect --cleanup
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>&gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*</screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Melden Sie sich beim SMT-Server an.
    </para>
   </step>
   <step>
    <para>
     Prüfen Sie, ob die Registrierung des Client aufgehoben wurde, indem Sie alle Client-Registrierungen aufrufen:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> smt-list-registrations</screen>
   </step>
   <step>
    <para>
     Wird der Hostname des Client in der Ausgabe dieses Kommandos noch aufgelistet, rufen Sie die <literal>Unique ID</literal> des Client in der ersten Spalte ab. (Der Client ist möglicherweise mit mehreren IDs aufgeführt.)
    </para>
   </step>
   <step>
    <para>
     Löschen Sie die Registrierung für diesen Client:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> smt-delete-registration -g <replaceable>UNIQUE_ID</replaceable></screen>
   </step>
   <step>
    <para>
     Sollte der Client mit mehreren IDs aufgeführt sein, wiederholen Sie den obigen Schritt für jede einzelne ID.
    </para>
   </step>
   <step>
    <para>
     Prüfen Sie danach, ob die Registrierung des Client nun aufgehoben wurde, indem Sie das folgende Kommando erneut ausführen:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> smt-list-registrations</screen>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-autoyast-profiles" os="sles">
  <title>Änderungen der AutoYaST-Profile von SLE 12 bis 15</title>

  <para>
   Informationen zur Migration von AutoYaST-Profilen finden Sie im <xref linkend="appendix-ay-12vs15"/>.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-smt-to-rmt" os="sles">
  <title>Upgraden eines Subscription Management Tool-(SMT-)Servers</title>

  <para>
   Für einen Server mit SMT ist ein besonderes Upgradeverfahren erforderlich. Weitere Informationen finden Sie im <xref linkend="cha-rmt-migrate"/> im Handbuch zum Repository Mirroring Tool.
  </para>
 </sect1>
 <sect1 os="sles" xml:id="sec-update-preparation-multiversion">
  <title>Vorübergehende Deaktivierung der Unterstützung mehrerer Kernel-Versionen</title>

  <para>
   <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> ermöglicht die Installation mehrerer Kernel-Versionen. Hierfür müssen die entsprechenden Einstellungen in <filename>/etc/zypp/zypp.conf</filename> aktiviert werden. Für das Upgrade auf ein Service Pack muss diese Funktion vorübergehend deaktiviert werden. Sobald die Aktualisierung erfolgreich abgeschlossen wurde, kann die Unterstützung mehrerer Versionen wieder aktiviert werden. Zur Deaktivierung der Unterstützung mehrerer Versionen müssen die entsprechenden Zeilen in <filename>/etc/zypp/zypp.conf</filename> kommentiert werden. Das Ergebnis sollte wie folgt aussehen:
  </para>

<screen>#multiversion = provides:multiversion(kernel)
#multiversion.kernels = latest,running</screen>

  <para>
   Wenn Sie diese Funktion nach einer erfolgreichen Aktualisierung wieder aktivieren möchten, entfernen Sie die Kommentarzeichen. Weitere Informationen zur Unterstützung mehrerer Versionen finden Sie im <xref linkend="sec-tuning-multikernel-enable"/>.
  </para>
 </sect1>
 <sect1 xml:id="sec-upgrade-prepare-boot-config">
  <title>Passen Sie den Boot-Parameter <literal>resume</literal> an</title>
  <para>
   Auf Systemen, die mit <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> 12 oder älter installiert wurden, kann die Standard-Kernel-Kommandozeile in <filename>/etc/default/grub</filename> einen Parameter <parameter>resume</parameter> enthalten, der den Namen eines Geräteknotens wie <filename>/dev/sda1</filename> verwendet, um auf das Hibernation-Gerät (Suspend-to-Disk) zu verweisen. Da die Namen von Geräteknoten nicht beständig sind und sich zwischen Neustarts ändern können, ist es sehr empfehlenswert, dies zu korrigieren. Andernfalls kann das aufgerüstete System beim Neustart hängenbleiben.
  </para>
  <procedure>
   <step>
    <para>
     Suchen Sie das Gerät für den Ruhezustand:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>grep resume /etc/default/grub</command>
GRUB_CMDLINE_LINUX_DEFAULT="resume=/dev/sda1 splash=silent quiet showopts"
</screen>
    <para>
     Das Gerät für den Ruhezustand ist <filename>/dev/sda1</filename>. Wenn das Kommando nichts zurückgibt, ist der Ruhezustand nicht konfiguriert.
    </para>
   </step>
   <step>
    <para>
     Rufen Sie die UUID für <filename><replaceable>/dev/sda1</replaceable></filename> ab:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>blkid /dev/vda1</command>
/dev/vda1: UUID="a1d1f2e0-b0ee-4be2-83d5-78a98c585827" TYPE="swap" PARTUUID="000134b5-01"</screen>
    <para>
     Die UUID für <filename>/dev/sda1</filename> lautet <literal>a1d1f2e0-b0ee-4be2-83d5-78a98c585827</literal>.
    </para>
   </step>
   <step>
    <para>
     Bearbeiten Sie <filename>/etc/default/grub</filename> und passen Sie den Parameter <parameter>resume</parameter> an. Ersetzen Sie <literal><replaceable>/dev/sda1</replaceable></literal> durch <literal><replaceable>UUID=a1d1f2e0-b0ee-4be2-83d5-78a98c585827</replaceable></literal>. Das Ergebnis sieht folgendermaßen aus:
    </para>
<screen>GRUB_CMDLINE_LINUX_DEFAULT="resume=UUID=a1d1f2e0-b0ee-4be2-83d5-78a98c585827 splash=silent quiet showopts"</screen>
   </step>
   <step>
    <para>
     Aktualisieren Sie die Konfiguration des Grub-Bootmanagers:
    </para>
<screen><prompt>&gt; </prompt><command>sudo</command> <command>grub2-mkconfig -o /boot/grub2/grub.cfg</command></screen>
   </step>
  </procedure>
  <para>
   Wenn das System den Ruhezustand nicht verwendet, können Sie den Parameter <parameter>resume</parameter> einfach entfernen und die Boot-Konfiguration aktualisieren.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-zseries" os="sles">
  <title>Upgraden auf IBM Z</title>

  <para>
   Für das einer SUSE Linux Enterprise-Installation auf IBM Z muss der Kernel-Parameter <command>Upgrade=1</command>Upgrade=  angegeben werden, z. B. in der parmfile. Weitere Informationen hierzu finden Sie im <xref linkend="sec-appdendix-parm"/>.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-ppc" os="sles" arch="power">
  <title>IBM POWER: Starten eines X-Servers</title>

  <para>
   Unter SLES 12 für IBM POWER ist der Anzeige-Manager so konfiguriert, dass ein lokaler X-Server nicht standardmäßig gestartet wird. Diese Einstellung wurde in SLES 12 SP1 rückgängig gemacht, sodass der Anzeige-Manager jetzt einen X-Server startet.
  </para>

  <para>
   Die <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>-Einstellung wird nicht automatisch geändert, damit keine Probleme im Rahmen des Upgrades auftreten. Wenn der Anzeige-Manager nach dem Upgrade einen X-Server starten soll, ändern Sie die Einstellung von <envar>DISPLAYMANAGER_STARTS_XSERVER</envar> in <filename>/etc/sysconfig/displaymanager</filename> wie folgt:
  </para>

<screen>DISPLAYMANAGER_STARTS_XSERVER="yes"</screen>
 </sect1>
</chapter>
